homeassistant:
  customize:
    package.node_anchors:
      customize: &customize
        Package: 'Consumi'
        Version: '2023.02.01'
        Author: 'Domenico Ceccarelli'
        icon: 'mdi:counter'
        #entity_picture: https://avatars1.githubusercontent.com/u/37450907?s=400&u=c6397fc94ead7e4c469bfd3c6fa6c50c599f1ea8&v=4
        reference: 'riddik14 - github chat telegram https://t.me/joinchat/Fanqz1jiL42Y0Hzd'
      expose: &expose
        <<: *customize
        haaska_hidden: false
        homebridge_hidden: false
        
        
    sensor.energia_kwh:
      <<: *customize
    input_number.costo_f1:
        <<: *customize
    input_datetime.f1_ora_inizio:
        <<: *customize
    sensor.consumo_giornaliero_f1:
        <<: *customize
    sensor.consumo_giornaliero_f2:
        <<: *customize
    sensor.consumo_giornaliero_f3:
        <<: *customize
    sensor.consumo_mensile_f1:
        <<: *customize
    sensor.consumo_mensile_f2:
        <<: *customize
    sensor.consumo_mensile_f3:
        <<: *customize
    sensor.consumo_annuale_f1:
        <<: *customize
    sensor.consumo_annuale_f2:
        <<: *customize
    sensor.consumo_annuale_f3:
        <<: *customize
        
        
  customize_glob:
    sensor.energia_kwh:
      <<: *customize
    input_number.costo_f1:
        <<: *customize
    input_number.f1_ora_inizio:
        <<: *customize
    sensor.consumo_giornaliero_f1:
        <<: *customize
    sensor.consumo_giornaliero_f2:
        <<: *customize
    sensor.consumo_giornaliero_f3:
        <<: *customize
    sensor.consumo_mensile_f1:
        <<: *customize
    sensor.consumo_mensile_f2:
        <<: *customize
    sensor.consumo_mensile_f3:
        <<: *customize
    sensor.consumo_annuale_f1:
        <<: *customize
    sensor.consumo_annuale_f2:
        <<: *customize
    sensor.consumo_annuale_f3:
        <<: *customize



 

 
#downloader:
#  download_dir: packages    
utility_meter:

  consumo_giornaliero:
    source: !secret Sensore
    cycle: daily 
    tariffs:
      - f1
      - f2
      - f3
  consumo_mensile:
    source: !secret Sensore
    cycle: monthly
    tariffs:
      - f1
      - f2
      - f3
  consumo_annuale:
    source: !secret Sensore
    cycle: yearly
    tariffs:
      - f1
      - f2
      - f3
template:
  - binary_sensor:
    - default_entity_id: binary_sensor.ultimo_giorno_mese
      icon: mdi:calendar
      name: ultimo_giorno_mese
      state: '{{ (as_timestamp(now()) + 86400)|timestamp_custom(''%d'', true) | int == 1 }}'

    - default_entity_id: binary_sensor.primo_giorno_mese
      icon: mdi:calendar
      name: primo_giorno_mese
      state: '{{ (as_timestamp(now()) )|timestamp_custom(''%d'', true) | int == 1 }}'

  - sensor:
    - name: Costo Consumo Oggi fascia 1
      unit_of_measurement: €
      default_entity_id: sensor.costo_consumo_oggi_f1
      icon: mdi:currency-eur
      state: '{{((states.sensor.consumo_giornaliero_f1.state | float(0)) * (states.sensor.pun_fascia_f1.state| float(0))) | round(2) }}'
    - name: Costo Consumo Oggi fascia 2
      unit_of_measurement: €
      default_entity_id: sensor.costo_consumo_oggi_f2
      icon: mdi:currency-eur
      state: '{{((states.sensor.consumo_giornaliero_f2.state | float(0)) * (states.sensor.pun_fascia_f2.state| float(0))) | round(2) }}'
    - name: Costo Consumo Oggi fascia 3
      unit_of_measurement: €
      default_entity_id: sensor.costo_consumo_oggi_f3
      icon: mdi:currency-eur
      state: '{{((states.sensor.consumo_giornaliero_f3.state | float(0)) * (states.sensor.pun_fascia_f3.state| float(0))) | round(2) }}'
    - name: Consumo Oggi
      unit_of_measurement: KWh
      default_entity_id: sensor.consumo_totale_oggi
      icon: mdi:counter
      state: '{{((states.sensor.consumo_giornaliero_f1.state | float(0)) + (states.sensor.consumo_giornaliero_f2.state | float(0)) + (states.sensor.consumo_giornaliero_f3.state | float(0))) | round(3) }}'
    - name: Costo Consumo Oggi
      unit_of_measurement: €
      default_entity_id: sensor.costo_consumo_oggi_totale
      icon: mdi:currency-eur
      state: '{{((states.sensor.costo_consumo_oggi_f1.state | float(0)) + (states.sensor.costo_consumo_oggi_f2.state| float(0)) + (states.sensor.costo_consumo_oggi_f3.state| float(0))) | round(2) }}'
    - name: Costo Consumo mensile fascia 1
      unit_of_measurement: €
      default_entity_id: sensor.costo_consumo_mensile_f1
      icon: mdi:currency-eur
      state: '{{((states.sensor.consumo_mensile_f1.state | float(0)) * (states.sensor.pun_fascia_f1.state| float(0))) | round(2) }}'
    - name: Costo Consumo mensile fascia 1
      unit_of_measurement: €
      default_entity_id: sensor.costo_consumo_mensile_f1
      icon: mdi:currency-eur
      state: '{{((states.sensor.consumo_mensile_f1.state | float(0)) * (states.sensor.pun_fascia_f1.state| float(0))) | round(2) }}'
    - name: Costo Consumo mensile fascia 3
      unit_of_measurement: €
      default_entity_id: sensor.costo_consumo_mensile_f3
      icon: mdi:currency-eur
      state: '{{((states.sensor.consumo_mensile_f3.state | float(0)) * (states.sensor.pun_fascia_f3.state| float(0))) | round(2) }}'
    - name: "Consumo mensile"
      icon: mdi:counter
      unit_of_measurement: "KWh"
      state: "{{ ((states('sensor.consumo_mensile_f1') | float(0)) +
                  (states('sensor.consumo_mensile_f2') | float(0)) +
                  (states('sensor.consumo_mensile_f3') | float(0))) | round(3) }}"

    - name: "Costo Consumo mensile"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: "{{ ((states('sensor.costo_consumo_mensile_f1') | float(0)) +
                  (states('sensor.costo_consumo_mensile_f2') | float(0)) +
                  (states('sensor.costo_consumo_mensile_f3') | float(0))) | round(2) }}"

    - name: "Costo Consumo annuale fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: "{{ (states('sensor.consumo_annuale_f1') | float(0)) * 
                 (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}"

    - name: "Costo Consumo annuale fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: "{{ (states('sensor.consumo_annuale_f2') | float(0)) * 
                 (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}"

    - name: "Costo Consumo annuale fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: "{{ (states('sensor.consumo_annuale_f3') | float(0)) * 
                 (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}"

    - name: "Consumo annuale"
      icon: mdi:counter
      unit_of_measurement: "KWh"
      state: "{{ ((states('sensor.consumo_annuale_f1') | float(0)) +
                  (states('sensor.consumo_annuale_f2') | float(0)) +
                  (states('sensor.consumo_annuale_f3') | float(0))) | round(3) }}"

    - name: "Costo Consumo annuale"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: "{{ ((states('sensor.costo_consumo_annuale_f1') | float(0)) +
                  (states('sensor.costo_consumo_annuale_f2') | float(0)) +
                  (states('sensor.costo_consumo_annuale_f3') | float(0))) | round(2) }}"

    - name: "Stima Costo Annuale"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo = states('sensor.costo_consumo_annuale_totale') | float(0) %}
        {% set energiaFissa = states('input_number.materia_energia_quota_fissa_annua') | float(0) %}
        {% set energia = energiaConsumo + energiaFissa %}
        {% set trasportoConsumo = (states('sensor.consumo_totale_annuale') | float(0)) *
                                   (states('input_number.trasporto_quota_energia') | float(0)) %}
        {% set trasportoFissa = states('input_number.trasporto_quota_fissa_annua') | float(0) %}
        {% set trasportoPotenza = (states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                                   (states('input_number.kw_contatore') | float(0)) %}
        {% set trasporto = trasportoConsumo + trasportoFissa + trasportoPotenza %}
        {% set oneri = (states('sensor.consumo_totale_annuale') | float(0)) *
                       (states('input_number.oneri_di_sistema_quota_energia') | float(0)) %}
        {% set accise = (states('sensor.consumo_totale_annuale') | float(0)) *
                        (states('input_number.accise') | float(0)) %}
        {% set iva = (energia + trasporto + oneri + accise) *
                     (states('input_number.iva') | float(0)) / 100 %}
        {{ (energia + trasporto + oneri + accise + iva) | round(2) }}

    - name: "Bolletta Stimata"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo = states('sensor.costo_consumo_mensile_totale') | float(0) %}
        {% set energiaFissa = (states('input_number.materia_energia_quota_fissa_annua') | float(0)) / 12 %}
        {% set energia = energiaConsumo + energiaFissa %}
        {% set trasportoConsumo = (states('sensor.consumo_totale_mensile') | float(0)) *
                                   (states('input_number.trasporto_quota_energia') | float(0)) %}
        {% set trasportoFissa = (states('input_number.trasporto_quota_fissa_annua') | float(0)) / 12 %}
        {% set trasportoPotenza = ((states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                                  (states('input_number.kw_contatore') | float(0))) / 12 %}
        {% set trasporto = trasportoConsumo + trasportoFissa + trasportoPotenza %}
        {% set oneri = (states('sensor.consumo_totale_mensile') | float(0)) *
                       (states('input_number.oneri_di_sistema_quota_energia') | float(0)) %}
        {% set accise = (states('sensor.consumo_totale_mensile') | float(0)) *
                        (states('input_number.accise') | float(0)) %}
        {% set iva = (energia + trasporto + oneri + accise) *
                     (states('input_number.iva') | float(0)) / 100 %}
        {% if is_state('input_select.fatturazione', 'mensile') %}
          {{ (energia + trasporto + oneri + accise + iva) | round(2) }}
        {% elif is_state('input_select.fatturazione', 'bimestrale') %}
          {{ ((energia + trasporto + oneri + accise + iva) * 2) | round(2) }}
        {% elif is_state('input_select.fatturazione', 'trimestrale') %}
          {{ ((energia + trasporto + oneri + accise + iva) * 3) | round(2) }}
        {% endif %}

    - name: "Quota Materia Energia"
      icon: mdi:flash
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo = states('sensor.costo_consumo_mensile_totale') | float(0) %}
        {% set energiaFissa = (states('input_number.materia_energia_quota_fissa_annua') | float(0)) / 12 %}
        {{ (energiaConsumo + energiaFissa) | round(2) }}

    - name: "Quota Trasporto"
      icon: mdi:truck-outline
      unit_of_measurement: "€"
      state: >
        {% set consumo = states('sensor.consumo_totale_mensile') | float(0) %}
        {% set q_energia = states('input_number.trasporto_quota_energia') | float(0) %}
        {% set q_fissa = (states('input_number.trasporto_quota_fissa_annua') | float(0)) / 12 %}
        {% set q_potenza = ((states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                             (states('input_number.kw_contatore') | float(0))) / 12 %}
        {{ (consumo * q_energia + q_fissa + q_potenza) | round(2) }}

    - name: "Quota Oneri di Sistema"
      icon: mdi:factory
      unit_of_measurement: "€"
      state: >
        {% set consumo = states('sensor.consumo_totale_mensile') | float(0) %}
        {% set q_oneri = states('input_number.oneri_di_sistema_quota_energia') | float(0) %}
        {{ (consumo * q_oneri) | round(2) }}

    - name: "Quota Accise"
      icon: mdi:scale-balance
      unit_of_measurement: "€"
      state: >
        {% set consumo = states('sensor.consumo_totale_mensile') | float(0) %}
        {% set q_accise = states('input_number.accise') | float(0) %}
        {{ (consumo * q_accise) | round(2) }}

    - name: "Quota IVA"
      icon: mdi:percent
      unit_of_measurement: "€"
      state: >
        {% set energia = states('sensor.quota_materia_energia') | float(0) %}
        {% set trasporto = states('sensor.quota_trasporto') | float(0) %}
        {% set oneri = states('sensor.quota_oneri_di_sistema') | float(0) %}
        {% set accise = states('sensor.quota_accise') | float(0) %}
        {% set iva = states('input_number.iva') | float(0) %}
        {{ ((energia + trasporto + oneri + accise) * iva / 100) | round(2) }}


    - name: "Consumo Ieri Fascia 1"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f1_yesterday') | float(0)) | round(3) }}

    - name: "Consumo Ieri Fascia 2"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f2_yesterday') | float(0)) | round(3) }}

    - name: "Consumo Ieri Fascia 3"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f3_yesterday') | float(0)) | round(3) }}

    - name: "Consumo Totale Ieri"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_ieri_fascia_1') | float(0)) +
            (states('sensor.consumo_ieri_fascia_2') | float(0)) +
            (states('sensor.consumo_ieri_fascia_3') | float(0))) | round(3) }}

    - name: "Costo Ieri Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_ieri_fascia_1') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Ieri Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_ieri_fascia_2') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Ieri Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_ieri_fascia_3') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Costo Ieri Totale"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_ieri_fascia_1') | float(0)) +
            (states('sensor.costo_ieri_fascia_2') | float(0)) +
            (states('sensor.costo_ieri_fascia_3') | float(0))) | round(2) }}
    - name: "Consumo Oggi Fascia 1"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f1_today') | float(0)) | round(3) }}

    - name: "Consumo Oggi Fascia 2"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f2_today') | float(0)) | round(3) }}

    - name: "Consumo Oggi Fascia 3"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f3_today') | float(0)) | round(3) }}

    - name: "Consumo Totale Oggi"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_oggi_fascia_1') | float(0)) +
            (states('sensor.consumo_oggi_fascia_2') | float(0)) +
            (states('sensor.consumo_oggi_fascia_3') | float(0))) | round(3) }}

    - name: "Costo Oggi Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_oggi_fascia_1') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Oggi Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_oggi_fascia_2') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Oggi Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_oggi_fascia_3') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Costo Oggi Totale"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_oggi_fascia_1') | float(0)) +
            (states('sensor.costo_oggi_fascia_2') | float(0)) +
            (states('sensor.costo_oggi_fascia_3') | float(0))) | round(2) }}


    - name: "Consumo Mese Scorso Fascia 1"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f1_last_month') | float(0)) | round(3) }}

    - name: "Consumo Mese Scorso Fascia 2"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f2_last_month') | float(0)) | round(3) }}

    - name: "Consumo Mese Scorso Fascia 3"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f3_last_month') | float(0)) | round(3) }}

    - name: "Consumo Totale Mese Scorso"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_mese_scorso_fascia_1') | float(0)) +
            (states('sensor.consumo_mese_scorso_fascia_2') | float(0)) +
            (states('sensor.consumo_mese_scorso_fascia_3') | float(0))) | round(3) }}

    - name: "Costo Mese Scorso Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mese_scorso_fascia_1') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Mese Scorso Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mese_scorso_fascia_2') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Mese Scorso Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mese_scorso_fascia_3') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Costo Totale Mese Scorso"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_mese_scorso_fascia_1') | float(0)) +
            (states('sensor.costo_mese_scorso_fascia_2') | float(0)) +
            (states('sensor.costo_mese_scorso_fascia_3') | float(0))) | round(2) }}

    - name: "Consumo Mese Corrente Fascia 1"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f1_current_month') | float(0)) | round(3) }}

    - name: "Consumo Mese Corrente Fascia 2"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f2_current_month') | float(0)) | round(3) }}

    - name: "Consumo Mese Corrente Fascia 3"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_energia_f3_current_month') | float(0)) | round(3) }}

    - name: "Consumo Totale Mese Corrente"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_mese_corrente_fascia_1') | float(0)) +
            (states('sensor.consumo_mese_corrente_fascia_2') | float(0)) +
            (states('sensor.consumo_mese_corrente_fascia_3') | float(0))) | round(3) }}

    - name: "Costo Mese Corrente Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mese_corrente_fascia_1') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Mese Corrente Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mese_corrente_fascia_2') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Mese Corrente Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mese_corrente_fascia_3') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Costo Totale Mese Corrente"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_mese_corrente_fascia_1') | float(0)) +
            (states('sensor.costo_mese_corrente_fascia_2') | float(0)) +
            (states('sensor.costo_mese_corrente_fascia_3') | float(0))) | round(2) }}

    - name: "Consumo Anno Precedente Fascia 1"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_annuale_f1_last_year') | float(0)) | round(3) }}

    - name: "Consumo Anno Precedente Fascia 2"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_annuale_f2_last_year') | float(0)) | round(3) }}

    - name: "Consumo Anno Precedente Fascia 3"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ (states('sensor.consumo_annuale_f3_last_year') | float(0)) | round(3) }}

    - name: "Consumo Totale Anno Precedente"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_anno_precedente_fascia_1') | float(0)) +
            (states('sensor.consumo_anno_precedente_fascia_2') | float(0)) +
            (states('sensor.consumo_anno_precedente_fascia_3') | float(0))) | round(3) }}

    - name: "Costo Anno Precedente Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_anno_precedente_fascia_1') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Anno Precedente Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_anno_precedente_fascia_2') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Anno Precedente Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_anno_precedente_fascia_3') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Costo Totale Anno Precedente"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_anno_precedente_fascia_1') | float(0)) +
            (states('sensor.costo_anno_precedente_fascia_2') | float(0)) +
            (states('sensor.costo_anno_precedente_fascia_3') | float(0))) | round(2) }}

    - name: "Bolletta Stimata Anno Precedente"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo = states('sensor.costo_totale_anno_precedente') | float(0) %}
        {% set energiaFissa = (states('input_number.materia_energia_quota_fissa_annua') | float(0)) %}
        {% set energia = energiaConsumo + energiaFissa %}
        {% set trasportoConsumo = (states('sensor.consumo_totale_anno_precedente') | float(0)) *
                                   (states('input_number.trasporto_quota_energia') | float(0)) %}
        {% set trasportoFissa = states('input_number.trasporto_quota_fissa_annua') | float(0) %}
        {% set trasportoPotenza = (states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                                   (states('input_number.kw_contatore') | float(0)) %}
        {% set trasporto = trasportoConsumo + trasportoFissa + trasportoPotenza %}
        {% set oneri = (states('sensor.consumo_totale_anno_precedente') | float(0)) *
                        (states('input_number.oneri_di_sistema_quota_energia') | float(0)) %}
        {% set accise = (states('sensor.consumo_totale_anno_precedente') | float(0)) *
                        (states('input_number.accise') | float(0)) %}
        {% set iva = ((energia + trasporto + oneri + accise) *
                     (states('input_number.iva') | float(0)) / 100) %}
        {{ (energia + trasporto + oneri + accise + iva) | round(2) }}

    - name: "Mese Precedente"
      icon: mdi:calendar-today
      state: >
        {% set mo = now().month %}
        {% set months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
                         "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"] %}
        {{ months[mo-2] }}

    - name: "Mese Corrente"
      icon: mdi:calendar-today
      state: >
        {% set mo = now().month %}
        {% set months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
                         "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"] %}
        {{ months[mo-1] }}

    - name: "Quota Energia Mensile"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo = states('sensor.costo_consumo_mese_corrente_totale') | float(0) %}
        {% set energiaFissa = (states('input_number.materia_energia_quota_fissa_annua') | float(0)) / 12 %}
        {{ (energiaConsumo + energiaFissa) | round(2) }}

    - name: "Trasporto Mensile"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set trasportoConsumo = (states('sensor.consumo_totale_mese_corrente') | float(0)) *
                                   (states('input_number.trasporto_quota_energia') | float(0)) %}
        {% set trasportoFissa = (states('input_number.trasporto_quota_fissa_annua') | float(0)) / 12 %}
        {% set trasportoPotenza = ((states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                                    (states('input_number.kw_contatore') | float(0))) / 12 %}
        {{ (trasportoConsumo + trasportoFissa + trasportoPotenza) | round(2) }}

    - name: "Oneri di Sistema Mensili"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set oneri = (states('sensor.consumo_totale_mese_corrente') | float(0)) *
                       (states('input_number.oneri_di_sistema_quota_energia') | float(0)) %}
        {{ oneri | round(2) }}

    - name: "Accise Mensili"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set accise = (states('sensor.consumo_totale_mese_corrente') | float(0)) *
                        (states('input_number.accise') | float(0)) %}
        {{ accise | round(2) }}

    - name: "IVA Mensile"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energia = (states('sensor.costo_consumo_mese_corrente_totale') | float(0)) +
                         ((states('input_number.materia_energia_quota_fissa_annua') | float(0))/12) %}
        {% set trasporto = (states('sensor.trasporto_mensile') | float(0)) %}
        {% set oneri = (states('sensor.oneri_di_sistema_mensili') | float(0)) %}
        {% set accise = (states('sensor.accise_mensili') | float(0)) %}
        {% set iva = (energia + trasporto + oneri + accise) * (states('input_number.iva') | float(0)) / 100 %}
        {{ iva | round(2) }}

    - name: "Bolletta Mensile Stimata"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energia = (states('sensor.costo_consumo_mese_corrente_totale') | float(0)) +
                         ((states('input_number.materia_energia_quota_fissa_annua') | float(0))/12) %}
        {% set trasporto = (states('sensor.trasporto_mensile') | float(0)) %}
        {% set oneri = (states('sensor.oneri_di_sistema_mensili') | float(0)) %}
        {% set accise = (states('sensor.accise_mensili') | float(0)) %}
        {% set iva = (states('sensor.iva_mensile') | float(0)) %}
        {% if is_state('input_select.fatturazione', 'mensile') %}
          {{ (energia + trasporto + oneri + accise + iva) | round(2) }}
        {% elif is_state('input_select.fatturazione', 'bimestrale') %}
          {{ ((energia + trasporto + oneri + accise + iva) * 2) | round(2) }}
        {% elif is_state('input_select.fatturazione', 'trimestrale') %}
          {{ ((energia + trasporto + oneri + accise + iva) * 3) | round(2) }}
        {% endif %}

    - name: "Costo Consumo Ieri Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_giornaliero_f1_last_period') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Consumo Ieri Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_giornaliero_f2_last_period') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Consumo Ieri Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_giornaliero_f3_last_period') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Consumo Totale Ieri"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_giornaliero_f1_last_period') | float(0)) +
            (states('sensor.consumo_giornaliero_f2_last_period') | float(0)) +
            (states('sensor.consumo_giornaliero_f3_last_period') | float(0))) | round(3) }}

    - name: "Costo Totale Ieri"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_consumo_ieri_fascia_1') | float(0)) +
            (states('sensor.costo_consumo_ieri_fascia_2') | float(0)) +
            (states('sensor.costo_consumo_ieri_fascia_3') | float(0))) | round(2) }}
    - name: "Costo Consumo Ieri Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_giornaliero_f1_last_period') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Consumo Ieri Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_giornaliero_f2_last_period') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Consumo Ieri Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_giornaliero_f3_last_period') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Consumo Totale Ieri"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_giornaliero_f1_last_period') | float(0)) +
            (states('sensor.consumo_giornaliero_f2_last_period') | float(0)) +
            (states('sensor.consumo_giornaliero_f3_last_period') | float(0))) | round(3) }}

    - name: "Costo Totale Ieri"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_consumo_ieri_fascia_1') | float(0)) +
            (states('sensor.costo_consumo_ieri_fascia_2') | float(0)) +
            (states('sensor.costo_consumo_ieri_fascia_3') | float(0))) | round(2) }}
    - name: "Costo Consumo Mese Scorso Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mensile_f1_last_period') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Consumo Mese Scorso Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mensile_f2_last_period') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Consumo Mese Scorso Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_mensile_f3_last_period') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Consumo Totale Mese Scorso"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_mensile_f1_last_period') | float(0)) +
            (states('sensor.consumo_mensile_f2_last_period') | float(0)) +
            (states('sensor.consumo_mensile_f3_last_period') | float(0))) | round(3) }}

    - name: "Costo Totale Mese Scorso"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_consumo_mese_scorso_fascia_1') | float(0)) +
            (states('sensor.costo_consumo_mese_scorso_fascia_2') | float(0)) +
            (states('sensor.costo_consumo_mese_scorso_fascia_3') | float(0))) | round(2) }}

    - name: "Bolletta Stimata Mese Scorso"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo_ms = states('sensor.costo_totale_mese_scorso') | float(0) %}
        {% set energiaFissa_ms = (states('input_number.materia_energia_quota_fissa_annua') | float(0)) / 12 %}
        {% set energia_ms = energiaConsumo_ms + energiaFissa_ms %}
        {% set trasportoConsumo_ms = (states('sensor.consumo_totale_mese_scorso') | float(0)) *
                                      (states('input_number.trasporto_quota_energia') | float(0)) %}
        {% set trasportoFissa_ms = (states('input_number.trasporto_quota_fissa_annua') | float(0)) / 12 %}
        {% set trasportoPotenza_ms = ((states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                                       (states('input_number.kw_contatore') | float(0))) / 12 %}
        {% set trasporto_ms = trasportoConsumo_ms + trasportoFissa_ms + trasportoPotenza_ms %}
        {% set oneri_ms = (states('sensor.consumo_totale_mese_scorso') | float(0)) *
                          (states('input_number.oneri_di_sistema_quota_energia') | float(0)) %}
        {% set accise_ms = (states('sensor.consumo_totale_mese_scorso') | float(0)) *
                           (states('input_number.accise') | float(0)) %}
        {% set iva_ms = ((energia_ms + trasporto_ms + oneri_ms + accise_ms) *
                         (states('input_number.iva') | float(0)) / 100) %}
        {% if is_state('input_select.fatturazione', 'mensile') %}
          {{ (energia_ms + trasporto_ms + oneri_ms + accise_ms + iva_ms) | round(2) }}
        {% elif is_state('input_select.fatturazione', 'bimestrale') %}
          {{ ((energia_ms + trasporto_ms + oneri_ms + accise_ms + iva_ms) * 2) | round(2) }}
        {% elif is_state('input_select.fatturazione', 'trimestrale') %}
          {{ ((energia_ms + trasporto_ms + oneri_ms + accise_ms + iva_ms) * 3) | round(2) }}
        {% endif %}

    - name: "Quota Energia Mese Scorso"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo_ms = states('sensor.costo_totale_mese_scorso') | float(0) %}
        {% set energiaFissa_ms = (states('input_number.materia_energia_quota_fissa_annua') | float(0)) / 12 %}
        {{ (energiaConsumo_ms + energiaFissa_ms) | round(2) }}

    - name: "Trasporto Mese Scorso"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set trasportoConsumo_ms = (states('sensor.consumo_totale_mese_scorso') | float(0)) *
                                      (states('input_number.trasporto_quota_energia') | float(0)) %}
        {% set trasportoFissa_ms = (states('input_number.trasporto_quota_fissa_annua') | float(0)) / 12 %}
        {% set trasportoPotenza_ms = ((states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                                       (states('input_number.kw_contatore') | float(0))) / 12 %}
        {{ (trasportoConsumo_ms + trasportoFissa_ms + trasportoPotenza_ms) | round(2) }}

    - name: "Oneri di Sistema Mese Scorso"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set oneri_ms = (states('sensor.consumo_totale_mese_scorso') | float(0)) *
                          (states('input_number.oneri_di_sistema_quota_energia') | float(0)) %}
        {{ oneri_ms | round(2) }}

    - name: "IVA Mese Scorso"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energia_ms = (states('sensor.costo_totale_mese_scorso') | float(0)) +
                           ((states('input_number.materia_energia_quota_fissa_annua') | float(0)) / 12) %}
        {% set trasporto_ms = states('sensor.trasporto_mese_scorso') | float(0) %}
        {% set oneri_ms = states('sensor.oneri_di_sistema_mese_scorso') | float(0) %}
        {% set accise_ms = (states('sensor.consumo_totale_mese_scorso') | float(0)) *
                           (states('input_number.accise') | float(0)) %}
        {% set iva_ms = (energia_ms + trasporto_ms + oneri_ms + accise_ms) *
                        (states('input_number.iva') | float(0)) / 100 %}
        {{ iva_ms | round(2) }}
    - name: "Costo Consumo Anno Precedente Fascia 1"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_annuale_f1_last_period') | float(0)) *
           (states('sensor.pun_fascia_f1') | float(0)) | round(2) }}

    - name: "Costo Consumo Anno Precedente Fascia 2"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_annuale_f2_last_period') | float(0)) *
           (states('sensor.pun_fascia_f2') | float(0)) | round(2) }}

    - name: "Costo Consumo Anno Precedente Fascia 3"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ (states('sensor.consumo_annuale_f3_last_period') | float(0)) *
           (states('sensor.pun_fascia_f3') | float(0)) | round(2) }}

    - name: "Consumo Totale Anno Precedente"
      icon: mdi:counter
      unit_of_measurement: "kWh"
      state: >
        {{ ((states('sensor.consumo_annuale_f1_last_period') | float(0)) +
            (states('sensor.consumo_annuale_f2_last_period') | float(0)) +
            (states('sensor.consumo_annuale_f3_last_period') | float(0))) | round(3) }}

    - name: "Costo Totale Anno Precedente"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {{ ((states('sensor.costo_consumo_anno_precedente_fascia_1') | float(0)) +
            (states('sensor.costo_consumo_anno_precedente_fascia_2') | float(0)) +
            (states('sensor.costo_consumo_anno_precedente_fascia_3') | float(0))) | round(2) }}

    - name: "Stima Costo Anno Precedente"
      icon: mdi:currency-eur
      unit_of_measurement: "€"
      state: >
        {% set energiaConsumo = states('sensor.costo_totale_anno_precedente') | float(0) %}
        {% set energiaFissa = states('input_number.materia_energia_quota_fissa_annua') | float(0) %}
        {% set energia = energiaConsumo + energiaFissa %}
        {% set trasportoConsumo = (states('sensor.consumo_totale_anno_precedente') | float(0)) *
                                  (states('input_number.trasporto_quota_energia') | float(0)) %}
        {% set trasportoFissa = states('input_number.trasporto_quota_fissa_annua') | float(0) %}
        {% set trasportoPotenza = (states('input_number.trasporto_quota_potenza_annua') | float(0)) *
                                   (states('input_number.kw_contatore') | float(0)) %}
        {% set trasporto = trasportoConsumo + trasportoFissa + trasportoPotenza %}
        {% set oneri = (states('sensor.consumo_totale_anno_precedente') | float(0)) *
                       (states('input_number.oneri_di_sistema_quota_energia') | float(0)) %}
        {% set accise = (states('sensor.consumo_totale_anno_precedente') | float(0)) *
                        (states('input_number.accise') | float(0)) %}
        {% set iva = ((energia + trasporto + oneri + accise) *
                      (states('input_number.iva') | float(0)) / 100) %}
        {{ (energia + trasporto + oneri + accise + iva) | round(2) }}

    - name: "Mese Precedente"
      icon: mdi:calendar-today
      state: >
        {% set mo = now().month %}
        {% set months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
                         "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"] %}
        {{ months[mo - 2] if mo > 1 else months[11] }}

    - name: "Mese Corrente"
      icon: mdi:calendar-today
      state: >
        {% set mo = now().month %}
        {% set months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno",
                         "Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"] %}
        {{ months[mo - 1] }}

sensor:
   - platform: integration
     source: !secret Sensore_w_to_kwh 
     name: energia_kwh
     unit_prefix: k
     round: 2


  # - platform: rest
  #   resource: https://raw.githubusercontent.com/riddik14/hassio-package-consumi/master/versione.json
  #   name: Versione pk consumi
  #   value_template: '{{ value_json.versione }}'

   #- platform: rest
    # resource: https://raw.githubusercontent.com/riddik14/hassio-package-consumi/master/versione.json
    # name: tipo aggiornamento pk consumi
    # value_template: '{{ value_json.cosa_aggiornare }}'




##--------------------AUTOMAZIONI PER CAMBIO FASCIA---------------------##      
automation:
#####################controllo aggiornamenti############################
 # - alias: controllo versione pkconsumi
 #   trigger:
 #   - platform: time
 #     at: '18:00'
 #   - event: start
 #     platform: homeassistant
 #   condition:
 #     - condition: template
 #       value_template: "{{ states('sensor.versione_pk_consumi') > (state_attr('input_number.costo_f1', 'Version')) }}"
 #   action:
 #   - service: input_boolean.turn_on
 #     data:
 #       entity_id: input_boolean.versione_pkconsumi

 # - alias: controllo versione reset pkconsumi
 #   trigger:
 #   - platform: time
 #     at: '18:05'
 #   - event: start
 #     platform: homeassistant
 #   condition:
 #     - condition: template
 #       value_template: "{{ states('sensor.versione_pk_consumi') == (state_attr('input_number.costo_f1', 'Version')) }}"
 #   action:
 #   - service: input_boolean.turn_off
 #     data:
 #       entity_id: input_boolean.versione_pkconsumi
#####################controllo aggiornamenti############################

  - alias: Cambio Tariffa F1
    initial_state: on
    trigger:
      - platform: state
        entity_id: input_select.numero_di_fasce
        to: '1'
      - platform: template
        value_template: >-
          {{ states('sensor.time') == (states.input_datetime.f1_ora_inizio.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: input_select.numero_di_fasce
          state: '1'
        - condition: state
          entity_id: binary_sensor.giorni_feriali
          state: 'on'
    action:
      - service: select.select_option
        target:
          entity_id: select.consumo_giornaliero
        data:
            option: f1
      - service: select.select_option
        target:
          entity_id: select.consumo_mensile
        data:
            option: f1
      - service: select.select_option
        target:
          entity_id: select.consumo_annuale
        data:
            option: f1
      

  - alias: Cambio Tariffa F2 - 2 fascie
    initial_state: on
    trigger:
      - platform: template
        value_template: >-
          {{ states('sensor.time') == (states.input_datetime.f2_ora_inizio_sera.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}
    condition:
      - condition: state
        entity_id: input_select.numero_di_fasce
        state: '2'
    action:
      - service: select.select_option
        target:
          entity_id: select.consumo_giornaliero
        data:
          option: f2
      - service: select.select_option
        target:
          entity_id: select.consumo_mensile
        data:
          option: f2
      - service: select.select_option
        target:
          entity_id: select.consumo_annuale
        data:
          option: f2
      


  - alias: Cambio Tariffa F2 - 3 fascie
    initial_state: on
    trigger:
      - platform: template
        value_template: >-
          {{ states('sensor.time') == (states.input_datetime.f2_ora_inizio_mattino.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}
      - platform: template
        value_template: >-
          {{ states('sensor.time') == (states.input_datetime.f2_ora_inizio_sera.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}
    condition:
      - condition: state
        entity_id: input_select.numero_di_fasce
        state: '3'
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.sabato
            state: 'on'
          - condition: state
            entity_id: binary_sensor.giorni_feriali
            state: 'on'
    action:
      - service: select.select_option
        target:
          entity_id: select.consumo_giornaliero
        data:
          option: f2
      - service: select.select_option
        target:
          entity_id: select.consumo_mensile
        data:
          option: f2
      - service: select.select_option
        target:
          entity_id: select.consumo_annuale
        data:
          option: f2
      


  - alias: Cambio Tariffa F3
    initial_state: on
    trigger:
      platform: template
      value_template: >-
        {{ states('sensor.time') == (states.input_datetime.f3_ora_inizio.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}
    condition:
      - condition: state
        entity_id: input_select.numero_di_fasce
        state: '3'
    action:
      - service: select.select_option
        target:
          entity_id: select.consumo_giornaliero
        data:
          option: f3
      - service: select.select_option
        target:
          entity_id: select.consumo_mensile
        data:
          option: f3
      - service: select.select_option
        target:
          entity_id: select.consumo_annuale
        data:
          option: f3

#invio messaggio storico
  - alias: messaggio_consumi_telegram
    trigger:
    - at: '23:59'
      platform: time
    condition:
    - condition: state
      entity_id: binary_sensor.ultimo_giorno_mese
      state: 'on'
    action:
    - service: notify.persistent_notification
      data:
        message: >-
           Nel mese di {{ states.sensor.mese_corrente.state }} hai consumato {{ states.sensor.consumo_totale_mensile.state }} kwh
           
           Energia                 {{ states.sensor.bolletta_energia.state }} €
           
           Trasporto               {{ states.sensor.bolletta_trasporto.state }} €
           
           Oneri di sistema    {{ states.sensor.bolletta_oneri_di_sistema.state }} €
           
           Iva                           {{ states.sensor.bolletta_iva.state }} €
           
           Totale                   {{ states.sensor.bolletta_tot.state }} €
    - service: !secret Servizio_Notifica_Consumi_Telegram
      data:
        title: Consumi
        message: >-
           Nel mese di {{ states.sensor.mese_corrente.state }} hai consumato {{ states.sensor.consumo_totale_mensile.state }} kwh
           
           Energia                 {{ states.sensor.bolletta_energia.state }} €
           
           Trasporto               {{ states.sensor.bolletta_trasporto.state }} €
           
           Oneri di sistema    {{ states.sensor.bolletta_oneri_di_sistema.state }} €
           
           Iva                           {{ states.sensor.bolletta_iva.state }} €
           
           Totale                   {{ states.sensor.bolletta_tot.state }} €
  - alias: messaggio_consumi_google_d1 #avviso via google 1 del mese ore 12.00
    trigger:
    - at: '12:00:00'
      platform: time
    condition:
    - condition: state
      entity_id: binary_sensor.ultimo_giorno_mese
      state: 'on'
    action:
    - data:
        entity_id: media_player.tutti
        message: >-
           Nel mese di {{ states.sensor.mese_precedente.state }} hai consumato {{ states.sensor.consumo_totale_mese_scorso.state }} kilo watt ora
           
           avarai una bolletta di circa {{ states.sensor.bolletta_tot_mese_scorso.state }} € per il solo mese di {{ states.sensor.mese_precedente.state }} 
      service: tts.cloud_say
  - alias: messaggio_consumi_alexa #avviso via alexa del mese ore 12.00 integrazione by radeon79
    trigger:
    - at: '12:00:00'
      platform: time
    condition:
    - condition: state
      entity_id: binary_sensor.ultimo_giorno_mese
      state: 'on'
    action:
    - data:
        target: 
          - media_player.echo
        data:
          type: tts
        message: >-
           Nel mese di {{ states.sensor.mese_precedente.state }} hai consumato {{ states.sensor.consumo_totale_mese_scorso.state }} kilo watt ora
           avrai una bolletta di circa {{ states.sensor.bolletta_tot_mese_scorso.state }} € per il solo mese di {{ states.sensor.mese_precedente.state }} 
      service: notify.alexa_media      




#binary_sensor:#

#last Day of the month Sensor
  #- platform: template
  #  sensors:
  #    ultimo_giorno_mese:
  #      friendly_name: 'ultimo_giorno_mese'
  #      #entity_id: sensor.date
  #      icon_template: "mdi:calendar"
  #      value_template: "{{ (as_timestamp(now()) + 86400)|timestamp_custom('%d', true) | int == 1 }}"
  #- platform: template
  #  senso#rs:
  #    primo_giorno_mese:
  #      friendly_name: 'primo_giorno_mese'
  #      #entity_id: sensor.date
  #      icon_template: "mdi:calendar"
  #      value_template: "{{ (as_timestamp(now()) )|timestamp_custom('%d', true) | int == 1 }}"
input_datetime:
  f1_ora_inizio:
    name: "Orario Inizio Fascia 1"
    has_date: false
    has_time: true
    initial: '08:00:00'
  f2_ora_inizio_mattino:
    name: "Orario Inizio Fascia 2 - Mattino"
    has_date: false
    has_time: true
    initial: '07:00:00'
  f2_ora_inizio_sera:
    name: "Orario Inizio Fascia 2 - Sera"
    has_date: false
    has_time: true
    initial: '19:00:00'
  f3_ora_inizio:
    name: "Orario Inizio Fascia 3"
    has_date: false
    has_time: true
    initial: '23:00:00'
input_number: 
  # Materia Energia
  materia_energia_quota_fissa_annua:
    name: Materia Energia Quota Fissa Annua
    min: 0.00
    max: 100.00
    unit_of_measurement: '€'
    initial: !secret MateriaEnergiaQuotaFissaAnnua
    mode: box
    icon: mdi:currency-eur
  costo_f1:
    name: Costo Energia elettrica Fascia 1
    min: 0.0000001
    max: 0.5000000
    unit_of_measurement: '€'
    initial: !secret TariffaF1
    mode: box
    icon: mdi:currency-eur
  costo_f2:
    name: Costo Energia elettrica Fascia 2
    min: 0.0000001
    max: 0.5000000
    unit_of_measurement: '€'
    initial: !secret TariffaF2
    mode: box
    icon: mdi:currency-eur
  costo_f3:
    name: Costo Energia elettrica Fascia 3
    min: 0.0000001
    max: 0.5000000
    unit_of_measurement: '€'
    initial: !secret TariffaF3
    mode: box
    icon: mdi:currency-eur
  # Trasporto costi unitari
  kw_contatore:
    name: Kw Contatore
    min: 1
    max: 30
    unit_of_measurement: 'Kw'
    initial: !secret KwContatore
    mode: box
  trasporto_quota_fissa_annua:
    name: Trasporto Quota Fissa Annua
    min: 0.000
    max: 100.000
    unit_of_measurement: '€'
    initial: !secret TrasportoQuotaFissaAnnua
    mode: box
    icon: mdi:currency-eur 
  trasporto_quota_potenza_annua:
    name: Trasporto Quota Potenza Annua
    min: 0.000
    max: 100.000
    unit_of_measurement: '€'
    initial: !secret TrasportoQuotaPotenzaAnnua
    mode: box
    icon: mdi:currency-eur
  trasporto_quota_energia:
    name: Trasporto Quota Energia
    min: 0.0000001
    max: 0.5000000
    unit_of_measurement: '€'
    initial: !secret TrasportoQuotaEnergia
    mode: box
    icon: mdi:currency-eur  
  # Oneri Di Sistema costi unitari 
  oneri_di_sistema_quota_energia:
    name: Oneri Di Sistema Quota Energia
    min: 0.0000001
    max: 0.5000000
    unit_of_measurement: '€'
    initial: !secret OneriDiSistemaQuotaEnergia
    mode: box
    icon: mdi:currency-eur  
  # Accisa costi unitari 
  accise:
    name: accise
    min: 0.0000001
    max: 0.5000000
    unit_of_measurement: '€'
    initial: !secret Accise
    mode: box
    icon: mdi:currency-eur
  # IVA
  iva:
    name: IVA
    min: 0.0000001
    max: 23
    unit_of_measurement: '%'
    initial: !secret Iva
    mode: box
    icon: mdi:percent
input_select:
  numero_di_fasce:
    name: Numero di Fasce
    options:
      - 1
      - 2
      - 3
    initial: !secret NumeroTariffe
  fatturazione:
    name: fatturazione
    options:
      - mensile
      - bimestrale
      - trimestrale
    initial: !secret Fatturazione
    icon: mdi:checkbox-marked-outline
input_boolean:
  versione_pkconsumi:
script:
  scarica_pkg:
    sequence:
      - service: notify.persistent_notification
        data:
          message: 'Aggiorno il pacchetto... attendere'
      - service: downloader.download_file
        data:
          url: 'https://raw.githubusercontent.com/riddik14/hassio-package-consumi/master/pkg_consumi.yaml'
          overwrite: true
      - delay: 5      
      - service: downloader.download_file
        data:
          url: 'https://raw.githubusercontent.com/riddik14/hassio-package-consumi/master/lovelace-dash-light.txt'
          overwrite: true
      - delay: 5
      #- service: homeassistant.restart
      - delay: 5
      - service: notify.persistent_notification
        data:
          message: 'Package Consumi Aggiornato. Ricarico i servizi'
      - delay: 1  
#      - service: homeassistant.restart
      - service: automation.reload
      - service: input_boolean.reload
      - service: input_select.reload
      - service: input_number.reload
      - service: input_datetime.reload
      - service: template.reload
      - service: notify.persistent_notification
        data:
          message: 'Servizi Ricaricati. ricarico in ultimo gli script'
      - service: script.reload
      - service: notify.notify
        data:
          message: 'Aggiornamento Pk Consumi Fatto, se vuoi puoi offrire un caffè al creatore del pacchetto a questo link https://www.buymeacoffee.com/T1Pqksy'
